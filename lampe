#!/bin/bash

bridgeip="192.168.2.172"

readKey() {
    # Wait for first char
    if read -s -n 1 _KEY; then
      	# Read rest of chars
      	while read -s -N 1 -t 0.001 ; do # FIXME is there a timeout-problem? 
      		_KEY+="${REPLY}"
      	done
		# echo -n ""
    fi

	# read -s -n 1 _KEY
}

declare _SELECTED_LAMP=1 # defaults to first lamp
declare _LAST_LAMP=51

readAKey() {
	# declare isCursor=0
	# readKey
	read -s -n 1 _KEY

	# XXX   catch cursor keys without modifiers (removed)
	# catch WASD for basic stuff
	case $_KEY in
		# $'\e[A' |
		"w")
			_UP=1
		;;
		# $'\e[B' |
		"s")
			_DOWN=1
		;;
		# $'\e[C' |
		"d")
			_RIGHT=1
		;;
		# $'\e[D' |
		"a")
			_LEFT=1
		;;
		"q")
			# hue
			_Q=1
		;;
		"e")
			# hue
			_E=1
		;;
		[1-9])
			# select the current lamp
			_SELECTED_LAMP=$_KEY
			_NEW_LAMP=$_KEY
		;;
	esac

	# if [ $isCursor != 1 ] ; then
	# 	echo -n "OTHER $_KEY "
	# fi
}


declare -a _BRIGHTNESS

# init saturation
declare -a _SAT
for (( s=1 ; s<10 ; s=s+1 )) ; do 
	_SAT[$s]=128
done

# init switch
declare -a _SWITCH # on or off
for (( s=1 ; s<10 ; s=s+1 )) ; do 
	_SWITCH[$s]="false"
done

# init color
declare -a _COLOR 
for (( s=1 ; s<10 ; s=s+1 )) ; do 
	_COLOR[$s]=12000 # orange
done

setBrightness() {
	brightness=${_BRIGHTNESS[$_SELECTED_LAMP]}
	
	brightness=$((brightness+$1))
	if [ $brightness -lt 1 ] ; then
		# switch off lamp
		setSwitch 0
		brightness=0
	elif [ $brightness -gt 0 ] ; then
		# switch on lamp
		setSwitch 1
		if [ $brightness -gt 254 ] ; then
			brightness=254
		fi
	fi

	_BRIGHTNESS[$_SELECTED_LAMP]=$brightness

	# debug
	# echo -n "param = $1 "
	# echo "brightness = ${_BRIGHTNESS[$_SELECTED_LAMP]} "
} 

setSat() {
	sat=${_SAT[$_SELECTED_LAMP]}
	
	sat=$((sat+$1))
	if [ $sat -lt 1 ] ; then
		sat=1
	elif [ $sat -gt 254 ] ; then
		sat=254
	fi

	_SAT[$_SELECTED_LAMP]=$sat
}

setColor() {
	hue=${_COLOR[$_SELECTED_LAMP]}
	
	hue=$((hue+$1))
	if [ $hue -lt 1 ] ; then
		hue=1
	elif [ $hue -gt 65280 ] ; then
		hue=65279
	fi

	# debug
	# echo " $hue "

	_COLOR[$_SELECTED_LAMP]=$hue
} 

setSwitch() {
	# debug
	# echo -n $1

	if [ $1 == 1 ] ; then 
		_SWITCH[$_SELECTED_LAMP]="true"
	else
		_SWITCH[$_SELECTED_LAMP]="false"
	fi
}

getColor() {
	hue=${_COLOR[$_SELECTED_LAMP]}

	bold=""
	if [ ${_SWITCH[$_SELECTED_LAMP]} = "true" ] ; then
		bold="lt"
	fi
	if [ $hue -lt 9001 ] ; then
		# red
		colorEscape="red"
	elif [ $hue -gt 9000 ] && [ $hue -lt 19001 ] ; then
		# orange, yellow
		colorEscape="yellow"
	elif [ $hue -gt 19000 ] && [ $hue -lt 31001 ] ; then
		# green
		colorEscape="green"
	elif [ $hue -gt 31000 ] && [ $hue -lt 35001 ] ; then
		# white, green-blue
		colorEscape="white"
	elif [ $hue -gt 35000 ] && [ $hue -lt 48001 ] ; then
		# blue
		colorEscape="blue"
	elif [ $hue -gt 48000 ] && [ $hue -lt 63279 ] ; then
		# purple
		colorEscape="magenta"
	elif [ $hue -gt 63279 ] ; then
		# red
		colorEscape="red"
	fi
	echo -en "$(color $bold$colorEscape)"
}

printMainScreen() {
	currentBrightness=$((_BRIGHTNESS[$_SELECTED_LAMP]/5))
	currentSat=$((_SAT[$_SELECTED_LAMP]*currentBrightness/254))

	echo -en "    \b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b"
	echo -en "Lamp $(getColor)$_SELECTED_LAMP $(color off)["
	for (( ii=0 ; ii<$currentBrightness ; ii=ii+1 )) ; do 
		# i=$((i+1))
		if [ $ii -lt $currentSat ] ; then
			echo -n "="
		else
			echo -n "-"
		fi
	done
	for (( ii=0 ; ii<50-$currentBrightness ; ii=ii+1 )) ; do
		echo -n " "
	done
	echo -n "] "
	if [ ${_SWITCH[$_SELECTED_LAMP]} != "true" ] ; then
		echo -n "off "
	else
		echo -n "    " # ^
	fi
}

toggleSwitch() {
	if [ ${_SWITCH[$_SELECTED_LAMP]} = "true" ] ; then
		setSwitch 0
	else 
		setSwitch 1
	fi
}

# clear
lastTime=$(date +%s)
while true; do
	# main loop

	# initialize global keys
	_UP=0
	_DOWN=0
	_RIGHT=0
	_LEFT=0
	_NEW_LAMP=51;
	_Q=0
	_E=0

	readAKey

	# handle brightness ans saturation
	if [ $_UP == 1 ] ; then
		# echo -n "heller "
		setBrightness 5
	fi
	if [ $_DOWN == 1 ] ; then
		# echo -n "dunkler "
		setBrightness -5
	fi
	if [ $_RIGHT == 1 ] ; then
		# echo -n "> "
		setSat 10
	fi
	if [ $_LEFT == 1 ] ; then
		# echo -n "< "
		setSat -10
	fi
	if [ $_Q == 1 ] ; then
		# hue
		setColor -1000
	fi
	if [ $_E == 1 ] ; then
		# hue
		setColor 1000
	fi

	# toggle switch
	if [ $_NEW_LAMP -lt 51 ] ; then
		# echo "NL$_NEW_LAMP LL$_LAST_LAMP "
		if [ $_LAST_LAMP == $_NEW_LAMP ] ; then
			toggleSwitch
			toggle=1
		else
			toggle=0
		fi
		_LAST_LAMP=$_NEW_LAMP
	else
		_LAST_LAMP=51
		toggle=0
	fi

	# TODO  hue
	if [ ${_SAT[$_SELECTED_LAMP]} -lt 1 ] ; then
		_SAT[$_SELECTED_LAMP]=1
	fi
	color="\"hue\":${_COLOR[$_SELECTED_LAMP]},\"bri\":${_BRIGHTNESS[$_SELECTED_LAMP]},\"sat\":${_SAT[$_SELECTED_LAMP]}"

	printMainScreen
	
	# send to hue bridge
	thisTime=$(date +%s)
	if [ $thisTime-$lastTime > 250000 ] || [ $toggle == 1 ] ; then
		curl -s -d "{\"on\":${_SWITCH[$_SELECTED_LAMP]},$color}" -X PUT http://$bridgeip/api/newdeveloper/lights/$_SELECTED_LAMP/state > /dev/null
		lastTime=$(date +%s)
	fi
	
done

